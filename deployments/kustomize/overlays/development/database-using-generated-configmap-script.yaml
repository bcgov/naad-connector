apiVersion: apps/v1
kind: Deployment
metadata:
  name: mariadb
spec:
  template:
    metadata:
      annotations:
        alpha.image.policy.openshift.io/resolve-names: '*'
        vault.hashicorp.com/agent-inject: 'true'
        vault.hashicorp.com/agent-inject-token: 'true'
        vault.hashicorp.com/agent-pre-populate-only: 'true'
        vault.hashicorp.com/auth-path: auth/k8s-silver
        vault.hashicorp.com/namespace: platform-services
        vault.hashicorp.com/secret-volume-path: /vault/secrets
        vault.hashicorp.com/role: bdf349-nonprod
        vault.hashicorp.com/agent-inject-secret-naad: bfd349-nonprod/dev
        vault.hashicorp.com/agent-inject-template-naad: |
          {{- with secret "bdf349-nonprod/dev" -}}
          export DESTINATION_PASSWORD="{{ .Data.data.DESTINATION_PASSWORD }}"
          export MARIADB_ROOT_PASSWORD="{{ .Data.data.MARIADB_ROOT_PASSWORD }}"
          export MARIADB_SERVICE_HOST="{{ .Data.data.MARIADB_SERVICE_HOST }}"
          export MARIADB_SERVICE_PORT="{{ .Data.data.MARIADB_SERVICE_PORT }}"
          {{- end }}
    spec:
      containers:
      - name: mariadb
        image: mariadb:11.5.2
        imagePullPolicy: Always
        command:
        - /entrypoint/entrypoint.sh
        volumeMounts:
        - name: entrypoint-script
          mountPath: /entrypoint
      volumes:
      - name: entrypoint-script
        configMap:
          name: mariadb-entrypoint  # Corrected to match configMapGenerator
          defaultMode: 0755  # 493 in decimal, but 0755 is more readable
      serviceAccountName: bdf349-vault
      serviceAccount: bdf349-vault
